compare_chart=function(){var t={};t.init=function(){t.graphData1=[],t.graphLabels1=[],t.graphData2=[],t.graphLabels2=[],t.$comparisonMethodField=$$(".comparison-method"),t.$deviceModelField=$$(".device-model"),t.$deviceCategoryField=$$(".device-category"),t.$zipcodeField=$$(".zipcode"),t.$comparisonMethodField.addEvent("change",function(){t.reloadGraphData()}),t.$deviceModelField.addEvent("change",function(){t.reloadGraphData()}),t.$deviceCategoryField.addEvent("change",function(){t.reloadGraphData()}),t.$zipcodeField.addEvent("change",function(){t.reloadGraphData()}),t.reloadGraphData()},t.reloadGraphData=function(){console.log("reloading graph");var a=t.$comparisonMethodField[0].getSelected().get("value"),e=t.$deviceModelField[0].getSelected().get("value"),r=t.$deviceCategoryField[0].getSelected().get("value"),o=t.$zipcodeField[0].get("value");new Request({url:"http://localhost:8888/api/measurements/",method:"get",onSuccess:function(a){var e=JSON.parse(a),r=t.parseJSONMeasurementsAsLabelAndData(e.current_user_measurements),o=t.parseJSONMeasurementsAsLabelAndData(e.average_measurements);t.graphLabels1=r.labels,t.graphData1=r.data,t.graphLabels2=o.labels,t.graphData2=o.data,t.drawLineGraph()},onFailure:function(){console.log("Request failed")}}).send("comparison_method="+a+"&device_model="+e+"&device_category_id="+r+"&zipcode="+o)},t.drawLineGraph=function(){function a(t,a,e,r,o,n){var i=(e-t)/2,h=(o-e)/2,d=Math.atan((e-t)/Math.abs(r-a)),c=Math.atan((o-e)/Math.abs(r-n));d=r>a?Math.PI-d:d,c=r>n?Math.PI-c:c;var l=Math.PI/2-(d+c)%(2*Math.PI)/2,s=i*Math.sin(l+d),p=i*Math.cos(l+d),u=h*Math.sin(l+c),f=h*Math.cos(l+c);return{x1:e-s,y1:r+p,x2:e+u,y2:r+f}}$("compare-chart").set("html","");var e=t.graphLabels1,r=t.graphData1,o=t.graphLabels2,n=t.graphData2,i=800,h=250,d=30,c=20,l=20,s=.6,p=.3,u="hsl("+[s,.5,.5]+")",f="hsl("+[p,.5,.5]+")",m=Raphael("compare-chart",i,h),v={font:"12px Helvetica, Arial",fill:"#000"},g=(i-d)/o.length,M=Math.max.apply(Math,n),y=(h-c-l)/M;m.drawGrid(d+.5*g+.5,l+.5,i-d-g,h-l-c,10,10,"#000");var x,F=m.path().attr({stroke:u,"stroke-width":4,"stroke-linejoin":"round"}),k=m.path().attr({stroke:f,"stroke-width":4,"stroke-linejoin":"round"}),w=m.set(),D=0,L=0,b=!1,G=m.set();w.push(m.text(0,0,"").attr(v)),w.hide();var S=m.popup(100,100,w,"right").attr({fill:"#fff",stroke:"#666","stroke-width":2,"fill-opacity":.7}).hide();!function(){for(var t,e,r=0,l=o.length;l>r;r++){{var s=Math.round(h-c-y*n[r]),p=Math.round(d+g*(r+.5));m.text(p,h-6,o[r]).attr(v).toBack()}if(r||(t=["M",p,s,"C",p,s],e=["M",d+.5*g,h-c,"L",p,s,"C",p,s]),r&&l-1>r){var f=Math.round(h-c-y*n[r-1]),M=Math.round(d+g*(r-.5)),$=Math.round(h-c-y*n[r+1]),F=Math.round(d+g*(r+1.5)),_=a(M,f,p,s,F,$);t=t.concat([_.x1,_.y1,p,s,_.x2,_.y2]),e=e.concat([_.x1,_.y1,p,s,_.x2,_.y2])}var z=m.circle(p,s,4).attr({fill:"#333",stroke:u,"stroke-width":2});G.push(m.rect(d+g*r,0,g,h-c).attr({stroke:"none",fill:"#fff",opacity:0}));var A=G[G.length-1];!function(t,a,e,r,o){A.hover(function(){clearTimeout(x);var r="right";t+S.getBBox().width>i&&(r="left");var n=m.popup(t,a,w,r,1),h=Raphael.animation({path:n.path,transform:["t",n.dx,n.dy]},200*b);D=w[0].transform()[0][1]+n.dx,L=w[0].transform()[0][2]+n.dy,S.show().stop().animate(h),w[0].attr({text:e}).show().stop().animateWith(S,h,{transform:["t",D,L]},200*b),o.attr("r",6),b=!0},function(){o.attr("r",4),x=setTimeout(function(){S.hide(),w[0].hide(),b=!1},1)})}(p,s,n[r],o[r],z)}t=t.concat([p,s,p,s]),e=e.concat([p,s,p,s,"L",p,h-c,"z"]),k.attr({path:t}),S.toFront(),w[0].toFront(),G.toFront()}(),function(){for(var t,o,n=0,l=e.length;l>n;n++){{var s=Math.round(h-c-y*r[n]),p=Math.round(d+g*(n+.5));m.text(p,h-6,e[n]).attr(v).toBack()}if(n||(t=["M",p,s,"C",p,s],o=["M",d+.5*g,h-c,"L",p,s,"C",p,s]),n&&l-1>n){var f=Math.round(h-c-y*r[n-1]),M=Math.round(d+g*(n-.5)),$=Math.round(h-c-y*r[n+1]),k=Math.round(d+g*(n+1.5)),_=a(M,f,p,s,k,$);t=t.concat([_.x1,_.y1,p,s,_.x2,_.y2]),o=o.concat([_.x1,_.y1,p,s,_.x2,_.y2])}var z=m.circle(p,s,4).attr({fill:"#333",stroke:u,"stroke-width":2});G.push(m.rect(d+g*n,0,g,h-c).attr({stroke:"none",fill:"#fff",opacity:0}));var A=G[G.length-1];!function(t,a,e,r,o){A.hover(function(){clearTimeout(x);var r="right";t+S.getBBox().width>i&&(r="left");var n=m.popup(t,a,w,r,1),h=Raphael.animation({path:n.path,transform:["t",n.dx,n.dy]},200*b);D=w[0].transform()[0][1]+n.dx,L=w[0].transform()[0][2]+n.dy,S.show().stop().animate(h),w[0].attr({text:e}).show().stop().animateWith(S,h,{transform:["t",D,L]},200*b),o.attr("r",6),b=!0},function(){o.attr("r",4),x=setTimeout(function(){S.hide(),w[0].hide(),b=!1},1)})}(p,s,r[n],e[n],z)}t=t.concat([p,s,p,s]),o=o.concat([p,s,p,s,"L",p,h-c,"z"]),F.attr({path:t}),S.toFront(),w[0].toFront(),G.toFront()}()},t.parseJSONMeasurementsAsLabelAndData=function(t){for(var a=[],e=[],r=0;r<t.length;r++){e.push(Math.round(100*t[r].value)/100);for(var o=0;o<times.length;o++)times[o].pk===t[r].time&&a.push(times[o].fields.time)}return{labels:a,data:e}},window.addEvent("domready",function(){t.init()})}();